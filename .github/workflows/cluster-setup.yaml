name: Deploy Cluster Addons & Applications

on:
    push:
        branches: [main]
        paths:
            - "k8s/**"
    pull_request:
        branches: [main]
        paths:
            - "k8s/**"
    workflow_dispatch:

env:
    TF_VAR_prefix: "devops3"

permissions:
    contents: read
    id-token: write

jobs:
    deploy:
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: k8s
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure Login
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Set AKS Context
              uses: azure/aks-set-context@v3
              with:
                  resource-group: ${{ env.TF_VAR_prefix }}-rg
                  cluster-name: ${{ env.TF_VAR_prefix }}-aks

            # --- Cluster Addons ---
            - name: Deploy Ingress Controller
              run: |
                  helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
                  helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
                    --namespace ingress-nginx --create-namespace

            - name: Deploy Prometheus
              run: |
                  helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                  helm upgrade --install prometheus prometheus-community/prometheus \
                    --namespace monitoring --create-namespace

            - name: Deploy Grafana
              run: |
                  helm repo add grafana https://grafana.github.io/helm-charts
                  helm upgrade --install grafana-t3 grafana/grafana \
                    --namespace monitoring --create-namespace \
                    -f k8s/grafana_values.yaml

            # --- Backend ---
            - name: Apply Backend Manifests
              run: |
                  kubectl apply -f k8s/backend/

            # --- Frontend ---
            - name: Apply Frontend Manifests
              run: |
                  kubectl apply -f k8s/frontend/
